<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Margem Varejo</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#013a63">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        :root {
            --bg-deep: #013a63;
            --glass: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --accent: #00d4ff;
            --winner: #39FF14;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background-color: var(--bg-deep);
            color: #ffffff;
            font-family: 'Segoe UI', sans-serif;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        h2 { font-size: 16px; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }

        .header-btns { display: flex; gap: 10px; margin-bottom: 10px; }

        .btn-header {
            background: transparent; border-radius: 20px;
            cursor: pointer; font-size: 10px;
            padding: 2px 15px; transition: 0.3s;
            text-transform: uppercase; font-weight: bold;
        }

        .btn-limpar { color: var(--accent); border: 1px solid var(--accent); }
        .btn-replicar { color: var(--winner); border: 1px solid var(--winner); }
        .btn-header:hover { background: rgba(255, 255, 255, 0.1); }

        .scenarios-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            width: 100%;
            max-width: 1400px;
            height: calc(100vh - 80px);
        }

        @media (max-width: 1024px) {
            body { overflow-y: auto; height: auto; }
            .scenarios-container { grid-template-columns: 1fr; height: auto; }
        }

        .card {
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
        }

        .card.winner { border: 2px solid var(--winner); box-shadow: 0 0 15px rgba(57, 255, 20, 0.2); }

        .scenario-title {
            background: var(--accent); color: #000;
            text-align: center; padding: 15px; border-radius: 6px;
            font-weight: bold; font-size: 18px; margin-bottom: 5px;
        }

        h4 {
            font-size: 15px; color: var(--accent);
            text-transform: uppercase; margin: 5px 0 3px 0;
            border-bottom: 1px solid rgba(0, 212, 255, 0.1);
        }

        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 3px; }
        .field label { display: block; font-size: 12px; color: var(--accent); margin-bottom: 1px; }

        input {
            width: 100%; background: rgba(0,0,0,0.4);
            border: 1px solid var(--glass-border); border-radius: 4px;
            color: #fff; padding: 4px; font-size: 11px;
        }

        .input-gross {
            background: rgba(0, 212, 255, 0.1) !important;
            border-color: var(--accent) !important;
            font-weight: bold;
        }

        .memoria-box { background: rgba(0,0,0,0.2); padding: 5px; border-radius: 6px; margin-top: 4px; }
        .result-line { display: flex; justify-content: space-between; font-size: 10px; margin-bottom: 2px; }

        .margem-final-display {
            background: var(--accent); color: #000;
            text-align: center; padding: 6px; border-radius: 6px;
            margin: 4px 0; font-weight: 900; font-size: 18px;
        }
        
        .analise-valor { font-weight: bold; color: #fff; font-size: 10px; }
    </style>
</head>
<body>

    <h2>Simulador Margem Varejo</h2>
    
    <div class="header-btns">
        <button class="btn-header btn-limpar" onclick="limparTodosCampos()">Limpar</button>
        <button class="btn-header btn-replicar" onclick="replicarCenario1()">Replicar</button>
    </div>

    <div class="scenarios-container">
        <script>
   function calcular(id, origem) {
    const getV = (name) => parseFloat(document.getElementById(`${name}_${id}`).value) || 0;
    const setV = (name, val) => document.getElementById(`${name}_${id}`).value = val.toFixed(2);

    let d3 = getV('d3');
    let d7 = getV('d7');
    const ipiP = getV('ipi'), icmsE = getV('icmsE'), pisE = getV('pisE');
    const d14 = getV('d14'), c17 = getV('mva'), icmsS = getV('icmsS'), pisS = getV('pisS');
    const contP = getV('cont'), d30 = getV('d30'), qVpc = getV('qvpc'), qSell = getV('qsell');

    if (origem === 'net') {
        const d6 = (pisE > 0) ? (d3 / (1 - (pisE/100))) - d3 : 0;
        const d5 = (icmsE > 0) ? ((d3 + d6) / (1 - (icmsE/100))) - (d3 + d6) : 0;
        d7 = d3 + d5 + d6;
        setV('d7', d7);
    } else if (origem === 'gross') {
        d3 = d7 * (1 - (pisE/100)) * (1 - (icmsE/100));
        setV('d3', d3);
    }

    const d5_calc = (icmsE > 0) ? (d7 - (d7 * (1 - (icmsE/100)))) : 0;
    const d12 = d7 * (1 + (ipiP/100));
    const d17 = d12 * (1 + (c17 / 100));
    const d18 = ((icmsS/100) * d17) - d5_calc;
    const d20 = -((pisS/100) * (d7 + (d7 * ipiP/100)));
    const d22 = d12 + d18 + d20;

    const d24 = d14 * (pisS/100);
    const lucroR = (d14 - d22 - d24) + (d3 * (contP/100)) + d30;
    const margemVal = (d14 > 0) ? (lucroR / (d14 - d24)) * 100 : 0;

    const f = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    
    // ATUALIZADO: Mostra margem negativa e muda a cor se for menor que zero
    const margemFinal = Math.round(margemVal);
    const campoMargem = document.getElementById(`margem_res_${id}`);
    campoMargem.innerText = "Margem: " + margemFinal + "%";
    
    // Estética: se a margem for negativa, o texto fica vermelho para alertar
    campoMargem.style.color = margemFinal < 0 ? "#ff3131" : "#000";
    
    document.getElementById(`vpc_res_${id}`).innerText = f(qVpc * d30);
    document.getElementById(`net_res_${id}`).innerText = f(qSell * d3);
    
    destacarMelhor();
}

function destacarMelhor() {
    let maior = -Infinity; 
    let vencedor = null;
    for(let i=1; i<=3; i++) {
        const textoRaw = document.getElementById(`margem_res_${i}`).innerText;
        // Agora aceita números negativos na comparação também
        const m = parseInt(textoRaw.replace('Margem: ', '').replace('%', '')) || -999;
        const card = document.getElementById(`card_${i}`);
        card.classList.remove('winner');
        if(m > maior) { maior = m; vencedor = card; }
    }
    // Só destaca se a margem for maior que 0
    if(vencedor && maior > 0) vencedor.classList.add('winner');
}

            function replicarCenario1() {
                const campos = ['d3', 'd7', 'ipi', 'icmsE', 'pisE', 'd14', 'mva', 'icmsS', 'pisS', 'cont', 'd30', 'qvpc', 'qsell'];
                campos.forEach(campo => {
                    const valorBase = document.getElementById(`${campo}_1`).value;
                    document.getElementById(`${campo}_2`).value = valorBase;
                    document.getElementById(`${campo}_3`).value = valorBase;
                });
                calcular(2, 'none');
                calcular(3, 'none');
            }

            function destacarMelhor() {
                let maior = -Infinity; 
                let vencedor = null;
                for(let i=1; i<=3; i++) {
                    const textoRaw = document.getElementById(`margem_res_${i}`).innerText;
                    const m = parseInt(textoRaw.replace('Margem: ', '').replace('%', '')) || 0;
                    const card = document.getElementById(`card_${i}`);
                    card.classList.remove('winner');
                    if(m > maior && m > 0) { maior = m; vencedor = card; }
                }
                if(vencedor) vencedor.classList.add('winner');
            }

            function limparTodosCampos() {
                document.querySelectorAll('input').forEach(i => i.value = "");
                for(let i=1; i<=3; i++) {
                    document.getElementById(`margem_res_${i}`).innerText = "0%";
                    document.getElementById(`vpc_res_${i}`).innerText = "R$ 0,00";
                    document.getElementById(`net_res_${i}`).innerText = "R$ 0,00";
                    document.getElementById(`card_${i}`).classList.remove('winner');
                }
            }

            for (let i = 1; i <= 3; i++) {
                document.write(`
                <div class="card" id="card_${i}">
                    <div class="scenario-title">CENÁRIO 0${i}</div>
                    <div>
                        <h4>Entrada</h4>
                        <div class="input-row">
                            <div class="field"><label>Net Fornec.</label><input type="number" id="d3_${i}" oninput="calcular(${i}, 'net')"></div>
                            <div class="field"><label>Custo Gross</label><input type="number" id="d7_${i}" class="input-gross" oninput="calcular(${i}, 'gross')"></div>
                        </div>
                        <div class="input-row">
                            <div class="field"><label>IPI %</label><input type="number" id="ipi_${i}" oninput="calcular(${i}, 'net')"></div>
                            <div class="field"><label>ICMS Ent %</label><input type="number" id="icmsE_${i}" oninput="calcular(${i}, 'net')"></div>
                        </div>
                        <div class="input-row">
                            <div class="field"><label>PIS/COF Ent %</label><input type="number" id="pisE_${i}" oninput="calcular(${i}, 'net')"></div>
                            <div class="field" style="visibility:hidden"><label>-</label><input type="number"></div>
                        </div>
                        <h4>Saída Varejo</h4>
                        <div class="input-row">
                            <div class="field"><label>Venda PSC</label><input type="number" id="d14_${i}" oninput="calcular(${i}, 'net')"></div>
                            <div class="field"><label>MVA %</label><input type="number" id="mva_${i}" oninput="calcular(${i}, 'net')"></div>
                        </div>
                        <div class="input-row">
                            <div class="field"><label>ICMS Saída %</label><input type="number" id="icmsS_${i}" oninput="calcular(${i}, 'net')"></div>
                            <div class="field"><label>PIS/COF Saída %</label><input type="number" id="pisS_${i}" oninput="calcular(${i}, 'net')"></div>
                        </div>
                        <h4>Acordos</h4>
                        <div class="input-row">
                            <div class="field"><label>Contrato %</label><input type="number" id="cont_${i}" oninput="calcular(${i}, 'net')"></div>
                            <div class="field"><label>VPC Unit.</label><input type="number" id="d30_${i}" oninput="calcular(${i}, 'net')"></div>
                        </div>
                    </div>
                    <div>
                        <div class="memoria-box">
                            <div class="margem-final-display"><span id="margem_res_${i}">0%</span></div>
                        </div>
                        <h4>Ação</h4>
                        <div class="input-row">
                            <div class="field"><label>Sell-in Qtd</label><input type="number" id="qsell_${i}" oninput="calcular(${i}, 'net')"></div>
                            <div class="field"><label>Qtd VPC</label><input type="number" id="qvpc_${i}" oninput="calcular(${i}, 'net')"></div>
                        </div>
                        <div class="memoria-box">
                            <div class="result-line"><span>VPC Tot</span><span class="analise-valor" id="vpc_res_${i}">R$ 0,00</span></div>
                            <div class="result-line"><span>Fat. Tot</span><span class="analise-valor" id="net_res_${i}">R$ 0,00</span></div>
                        </div>
                    </div>
                </div>
                `);
            }
        </script>
    </div>

    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js')
          .then(() => console.log("PWA Ativo!"))
          .catch((err) => console.log("Erro PWA:", err));
      }
    </script>
</body>
</html>
